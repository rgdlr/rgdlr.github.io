<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario</title>
    <style>
        :root {
            --color: #111;
            --background-color: #eee;
        }

        body {
            color: var(--color);
            background-color: var(--background-color);
            font-family: system-ui;
            overflow: hidden;
        }

        *, *::after, *::before {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        svg {
            stroke: var(--color);
        }

        .calendar {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            margin-top: 0.5rem;
            margin-inline: auto;
            max-width: 50rem;
            min-width: fit-content;
            overflow-x: hidden;
            padding-inline: 0.5rem;
        }

        .calendar__nav {
            align-items: center;
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
        }

        .calendar__buttons {
            display: flex;
            gap: 0.5rem;
        }

        .calendar__button {
            align-items: center;
            aspect-ratio: 1;
            background-color: #5552;
            border: none;
            display: flex;
            justify-content: center;
            min-height: 2.5rem;
        }

        .calendar__button:focus,
        .calendar__button:hover {
            background-color: #5551;
        }

        .calendar__title,
        .calendar__next-office-day,
        .calendar__total-office-days,
        .calendar__extra-office-days {
            background-color: #5552;
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
            padding: 0.5rem 1rem;
        }

        .calendar__title {
            font-weight: bold;
            justify-content: center;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .calendar__extra-office-days {
            margin-bottom: 0.5rem;
        }

        .calendar__dot-line {
            border-bottom: 0.1rem dotted var(--color);
            flex-grow: 1;
            margin-bottom: 0.25rem;
            opacity: 0.25;
        }

        .calendar__months {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            margin-bottom: 0.5rem;
            width: 100%;
        }

        .calendar__month {
            background-color: #5552;
            font-weight: bold;
            grid-column: span 7;
            padding: 0.5rem;
            text-align: center;
        }

        .calendar__weekday {
            background-color: #5551;
            font-weight: bold;
            padding: 0.5rem;
            text-align: center;
        }

        .calendar__day {
            min-height: 36px;
            padding: 0.5rem;
            text-align: center;
        }

        .calendar__day--office,
        .calendar__day--non-working {
            position: relative;
        }

        .calendar__day--office {
            background-color: #ee5959cc;
        }

        .calendar__day--non-working {
            background-color: #46a728cc;
        }

        .calendar__day--office::after,
        .calendar__day--non-working::after {
            align-items: center;
            background-color: inherit;
            display: flex;
            justify-content: center;
            opacity: 0;
            position: absolute;
            transition: opacity 500ms ease;
            visibility: hidden;
        }

        .calendar__day--office::after {
            content: "Oficina";
            font-size: 0.7rem;
            inset: 0;
        }

        .calendar__day--non-working::after {
            content: attr(title);
            font-size: 0.7rem;
            inset: 0 -3.335rem;
            padding: 0.5rem;
            z-index: 1;
        }

        .calendar__day--non-working.calendar__day--lun::after {
            transform: translateX(33.335%);
        }

        .calendar__day--non-working.calendar__day--dom::after {
            transform: translateX(-33.335%);
        }

        .calendar__day--office:focus::after,
        .calendar__day--office:hover::after,
        .calendar__day--non-working:focus::after,
        .calendar__day--non-working:hover::after {
            opacity: 1;
            visibility: visible;
        }

        .calendar__day--sáb:not(.calendar__day--non-working),
        .calendar__day--dom:not(.calendar__day--non-working) {
            color: #46a72880;
        }

        .calendar__today {
            outline: 0.1rem dashed #4646da;
            color: #4646da;
            font-weight: bold;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color: #eee;
                --background-color: #111;
            }
            .calendar__day--office {
                background-color: #da4f4fcc;
            }
            .calendar__day--non-working {
                background-color: #359119cc;
            }
        }

        .animate-prev-in {
            animation: animatePrevIn 125ms forwards;
        }

        @keyframes animatePrevIn {
            from {
                transform: translateX(-25%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-prev-out {
            animation: animatePrevOut 125ms forwards;
        }

        @keyframes animatePrevOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(25%);
                opacity: 0;
            }
        }

        .animate-next-in {
            animation: animateNextIn 125ms forwards;
        }

        @keyframes animateNextIn {
            from {
                transform: translateX(25%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .animate-next-out {
            animation: animateNextOut 125ms forwards;
        }

        @keyframes animateNextOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(-25%);
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="calendar">
        <div class="calendar__title">HaztePull</div>
        <div class="calendar__next-office-day">
            <span>Día siguiente</span>
            <span class="calendar__dot-line"></span>
            <strong class="calendar__next-office-day-date"></strong>
        </div>
        <div class="calendar__total-office-days">
            <span>Días totales desde el cambio</span>
            <span class="calendar__dot-line"></span>
            <strong class="calendar__total-office-days-number"></strong>
        </div>
        <div class="calendar__extra-office-days">
            <span>Días extra desde el cambio</span>
            <span class="calendar__dot-line"></span>
            <strong class="calendar__extra-office-days-number"></strong>
        </div>
        <div class="calendar__months"></div>
        <nav class="calendar__nav">
            <div class="calendar__buttons">
                <button class="calendar__button calendar__button--prev-year">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-left"><path d="m11 17-5-5 5-5"/><path d="m18 17-5-5 5-5"/></svg>
                </button>
                <button class="calendar__button calendar__button--prev-month">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>
                </button>
            </div>
            <div class="calendar__buttons">
                <button class="calendar__button calendar__button--next-month">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>
                </button>
                <button class="calendar__button calendar__button--next-year">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-right"><path d="m6 17 5-5-5-5"/><path d="m13 17 5-5-5-5"/></svg>
                </button>
            </div>
        </nav>
    </div>
    <script>
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        const months = [
            { name: 'Enero', days: 31 },
            { name: 'Febrero', days: 28 },
            { name: 'Marzo', days: 31 },
            { name: 'Abril', days: 30 },
            { name: 'Mayo', days: 31 },
            { name: 'Junio', days: 30 },
            { name: 'Julio', days: 31 },
            { name: 'Agosto', days: 31 },
            { name: 'Septiembre', days: 30 },
            { name: 'Octubre', days: 31 },
            { name: 'Noviembre', days: 30 },
            { name: 'Diciembre', days: 31 }
        ];

        function formatNumberDigits(number, digits = 2) {
            return number.toString().padStart(digits, '0');
        }

        function getWeekNumber(date) {
            date = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
            const weekNumber = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
            return weekNumber;
        }

        function getOfficeDays(weekNumber, year) {
            const weekBase = 36;
            const yearBase = 2024;
            if (year < yearBase || (year === yearBase && weekNumber < weekBase)) {
                return [];
            }
            let weeksFromBase;
            if (year > yearBase || (year === yearBase && weekNumber >= weekBase)) {
                weeksFromBase = (year - yearBase) * 52 + (weekNumber - weekBase);
            } else {
                weeksFromBase = (year - yearBase) * 52 + (weekNumber - weekBase);
                if (weeksFromBase < 0) {
                    weeksFromBase = (year - yearBase) * 52 + (weekNumber - weekBase);
                }
            }
            const patternWeek = ((weeksFromBase % 3) + 3) % 3;
            if (patternWeek === 0 || patternWeek === 2) {
                return ['jueves', 'viernes'];
            } else if (patternWeek === 1) {
                return ['jueves'];
            }
            return [];
        }

        async function getNonWorkingDays({ countryIsoCode = "ES", languageIsoCode = "ES", validFrom = `${new Date().getFullYear()}-01-01`, validTo = `${new Date().getFullYear()}-12-31`, subdivisionCode = "ES-MD" }) {
            const api = new URL("https://openholidaysapi.org/PublicHolidays");
            api.searchParams.append("countryIsoCode", countryIsoCode);
            api.searchParams.append("languageIsoCode", languageIsoCode);
            api.searchParams.append("validFrom", validFrom);
            api.searchParams.append("validTo", validTo);
            api.searchParams.append("subdivisionCode", subdivisionCode);

            const response = await fetch(api, { method: 'GET', cache: 'force-cache' });
            const data = response.json();
            return data;
        }

        function renderCalendar() {
            const calendarElement = document.querySelector('.calendar__months');
            calendarElement.innerHTML = '';

            const month = months[currentMonth];
            const monthYearLabel = document.createElement('div');
            monthYearLabel.className = 'calendar__month';
            monthYearLabel.innerText = `${month.name} ${currentYear}`;
            calendarElement.appendChild(monthYearLabel);

            const dayHeaders = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
            dayHeaders.forEach(header => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar__weekday';
                dayHeader.innerText = header;
                calendarElement.appendChild(dayHeader);
            });

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = month.days;

            const startDay = (firstDay === 0 ? 6 : firstDay - 1);
            const days = Array(startDay).fill(null);

            for (let day = 1; day <= daysInMonth; day++) {
                days.push(day);
            }

            const totalDays = days.length;
            const daysNeeded = 42 - totalDays;

            for (let i = 0; i < daysNeeded; i++) {
                days.push(null);
            }

            const today = new Date();
            const todayDay = today.getDate();
            const todayMonth = today.getMonth();
            const todayYear = today.getFullYear();

            days.forEach((day, i) => {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar__day';
                dayElement.classList.add(`calendar__day--${dayHeaders[i % 7].toLocaleLowerCase()}`);

                if (day) {
                    dayElement.innerText = day;
                    dayElement.classList.add(`calendar__day--${formatNumberDigits(day)}`);
                    const date = new Date(currentYear, currentMonth, day);
                    const weekNumber = getWeekNumber(date);
                    const officeDays = getOfficeDays(weekNumber, currentYear);
                    const dayOfWeek = date.toLocaleDateString('es-ES', { weekday: 'long' });
                    if (officeDays.includes(dayOfWeek)) {
                        dayElement.classList.add('calendar__day--office');
                        dayElement.setAttribute('tabindex', '0');
                    }
                    if (day === todayDay && currentMonth === todayMonth && currentYear === todayYear) {
                        dayElement.classList.add('calendar__today');
                    }
                }
                calendarElement.appendChild(dayElement);
            });

            getNonWorkingDays({
                validFrom: `${currentYear}-${formatNumberDigits(currentMonth + 1)}-01`,
                validTo: `${currentMonth === 11 ? currentYear + 1: currentYear}-${formatNumberDigits(currentMonth === 11 ? 1 : currentMonth + 2)}-01`,
            }).then((data) => {
                data.forEach(({ startDate, endDate, name }) => {
                    console.log({data});
                    const DATE_DAY = 2;
                    const startDay = startDate.split("-")[DATE_DAY];
                    const endDay = endDate.split("-")[DATE_DAY];
                    for (let day = startDay; Number(day) <= Number(endDay); day++) {
                        const dayElement = document.querySelector(`.calendar__day--${day}`);
                        dayElement?.classList?.add?.('calendar__day--non-working');
                        dayElement.setAttribute('tabindex', '0');   
                        dayElement?.setAttribute("title", name[0].text);
                    }
                });
            });
        }

        function getNextOfficeDay(date = new Date()) {
            const weekNumber = getWeekNumber(date);
            const officeDays = getOfficeDays(weekNumber, date.getFullYear());
            const dayOfWeek = date.toLocaleDateString('es-ES', { weekday: 'long' });
            if (officeDays.includes(dayOfWeek)) {
                return date;
            }
            date.setDate(date.getDate() + 1);
            return getNextOfficeDay(date);
        }

        function renderNextOfficeDay() {
            const nextOfficeDayElement = document.querySelector('.calendar__next-office-day-date');
            const nextOfficeDay = getNextOfficeDay();
            nextOfficeDayElement.innerText = nextOfficeDay.toLocaleDateString('es-ES', { weekday: 'long', day: '2-digit', month: '2-digit' }).replace(',', '');
        }

        function renderTotalOfficeDays() {
            const totalOfficeDaysElement = document.querySelector('.calendar__total-office-days-number');
            const today = new Date();
            const weekNumberToday = getWeekNumber(today);
            const currentYear = today.getFullYear();
            let totalDaysFromChange = 0;
            let year = 2024;
            let week = 36;
            while (year < currentYear || (year === currentYear && week <= weekNumberToday)) {
                const officeDays = getOfficeDays(week, year);
                totalDaysFromChange += officeDays.length;
                week++;
                if (week > 52) {
                    week = 1;
                    year++;
                }
            }
            totalOfficeDaysElement.innerText = totalDaysFromChange;
        }

        function renderExtraOfficeDays() {
            const extraOfficeDaysElement = document.querySelector('.calendar__extra-office-days-number');
            const today = new Date();
            const weekNumberToday = getWeekNumber(today);
            const currentYear = today.getFullYear();
            let extraDaysFromChange = 0;
            let year = 2024;
            let week = 36;
            const originalPattern = [1, 1, 2];
            let patternIndex = 0;
            while (year < currentYear || (year === currentYear && week <= weekNumberToday)) {
                const officeDays = getOfficeDays(week, year);
                const originalOfficeDays = originalPattern[patternIndex];
                extraDaysFromChange += (officeDays.length - originalOfficeDays);
                week++;
                if (week > 52) {
                    week = 1;
                    year++;
                }
                patternIndex = (patternIndex + 1) % originalPattern.length;
            }
            extraOfficeDaysElement.innerText = extraDaysFromChange;
        }

        function animateCalendar(navigation, callback) {
            const calendarElement = document.querySelector('.calendar__months');
            if (navigation === "prev") {
                calendarElement.classList.add('animate-prev-out');
                calendarElement.addEventListener('animationend', function handleAnimationEnd() {
                    calendarElement.classList.remove('animate-prev-out');
                    callback();
                    calendarElement.classList.add('animate-prev-in');
                    calendarElement.addEventListener('animationend', function handleAnimateInEnd() {
                        calendarElement.classList.remove('animate-prev-in');
                        calendarElement.removeEventListener('animationend', handleAnimateInEnd);
                    });
                    calendarElement.removeEventListener('animationend', handleAnimationEnd);
                });
            }
            if (navigation === "next") {
                calendarElement.classList.add('animate-next-out');
                calendarElement.addEventListener('animationend', function handleAnimationEnd() {
                    calendarElement.classList.remove('animate-next-out');
                    callback();
                    calendarElement.classList.add('animate-next-in');
                    calendarElement.addEventListener('animationend', function handleAnimateInEnd() {
                        calendarElement.classList.remove('animate-next-in');
                        calendarElement.removeEventListener('animationend', handleAnimateInEnd);
                    });
                    calendarElement.removeEventListener('animationend', handleAnimationEnd);
                });
            }
        }

        function prevYear() {
            animateCalendar("prev", () => {
                currentYear--;
                renderCalendar();
            });
        }

        function prevMonth() {
            animateCalendar("prev", () => {
                if (currentMonth > 0) {
                    currentMonth--;
                } else {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });
        }

        function nextMonth() {
            animateCalendar("next", () => {
                if (currentMonth < 11) {
                    currentMonth++;
                } else {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });
        }

        function nextYear() {
            animateCalendar("next", () => {
                currentYear++;
                renderCalendar();
            });
        }

        function addButtonNavigationEventListeners () {
            const prevYearElement = document.querySelector('.calendar__button--prev-year');
            const prevMonthElement = document.querySelector('.calendar__button--prev-month');
            const nextMonthElement = document.querySelector('.calendar__button--next-month');
            const nextYearElement = document.querySelector('.calendar__button--next-year');

            function navigateListener(navigation, time) {
                const navigateYear = navigation === "prev" ? prevYear : nextYear;
                const navigateMonth = navigation === "prev" ? prevMonth : nextMonth;
                const navigate = time === "year" ? navigateYear : navigateMonth;
                return ["click", navigate];
            }

            prevYearElement.addEventListener(...navigateListener("prev", "year"));
            nextMonthElement.addEventListener(...navigateListener("next", "month"));
            prevMonthElement.addEventListener(...navigateListener("prev", "month"));
            nextYearElement.addEventListener(...navigateListener("next", "year"));

            const removeZoomOnDblClickListener = ["dblclick", function removeZoomOnDblClick (event) {
                event.preventDefault();
                event.stopPropagation();
            }];

            prevYearElement.addEventListener(...removeZoomOnDblClickListener);
            prevMonthElement.addEventListener(...removeZoomOnDblClickListener);
            nextMonthElement.addEventListener(...removeZoomOnDblClickListener);
            nextYearElement.addEventListener(...removeZoomOnDblClickListener);
        }

        function addSwipeNavigationEventListeners() {
            const calendarElement = document.querySelector('.calendar');

            let startX = 0;
            let endX = 0;
            let isMouseDown = false;

            function handleGesture() {
                if (endX < startX - 50) {
                    nextMonth();
                }

                if (endX > startX + 50) {
                    prevMonth();
                }
            }

            calendarElement.addEventListener('touchstart', (event) => {
                startX = event.changedTouches[0].screenX;
            });

            calendarElement.addEventListener('touchend', (event) => {
                endX = event.changedTouches[0].screenX;
                handleGesture();
            });

            calendarElement.addEventListener('mousedown', (event) => {
                startX = event.screenX;
                isMouseDown = true;
            });

            calendarElement.addEventListener('mousemove', (event) => {
                if (isMouseDown) {
                    endX = event.screenX;
                }
            });

            calendarElement.addEventListener('mouseup', (event) => {
                if (isMouseDown) {
                    endX = event.screenX;
                    handleGesture();
                    isMouseDown = false;
                }
            });

            calendarElement.addEventListener('mouseleave', () => {
                isMouseDown = false;
            });
        }

        renderCalendar();
        renderNextOfficeDay();
        renderTotalOfficeDays();
        renderExtraOfficeDays();

        addButtonNavigationEventListeners();
        addSwipeNavigationEventListeners();
    </script>
</body>

</html>